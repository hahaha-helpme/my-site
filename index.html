<!DOCTYPE html>
<html lang="nl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet" />


  <!-- LinkRenderer: cellRenderer voor hyperlink-kolommen -->
  <script src="script/link-renderer.js"></script>

  <!-- ImageRenderer: cellRenderer voor afbeelding-kolommen -->
  <script src="script/image-renderer.js"></script>

  <!-- formatEuroCompact() : compacte €-notatie (K / M) -->
  <script src="script/format-euro-compact.js"></script>

  <!-- formatEuro() : standaard €-notatie met twee decimalen -->
  <script src="script/format-euro.js"></script>

  <!-- showStockChart() : Chart-logica -->
  <script src="script/chart.js"></script>


  <!-- AG Grid + AG Charts -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ag-charts-community/dist/umd/ag-charts-community.js"></script>


  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    #myGrid {
      overflow-x: auto;
    }
  </style>
</head>


<body>
  <div id="myGrid" style="height: 100%; width: 100%"></div>


  <script>

    const defaultColDef = {
      cellStyle: {
        fontFamily: "Inter, sans-serif",
        fontWeight: "300",
        textAlign: "left",
        fontSize: "13px",
      },
      width: 140,
      resizable: true,
      editable: false,
      filter: true,
      sortable: true,
    }


    const columnTypes = {
      customNumericColumn: {
        cellDataType: 'number',
        filter: 'agNumberColumnFilter',
        // cellEditor: 'agNumberCellEditor',
        // cellStyle: { textAlign: 'left' }, // Lijn de *getallen in de cellen* rechts uit.
        // headerStyle: { textAlign: 'left' }, // <--- HIER LIJN JE DE *HEADER TEKST* LINKS UIT.
        // editable: true, // Numerieke kolommen zijn standaard bewerkbaar als dit type wordt gebruikt.
        // sortable: true, // Numerieke kolommen zijn sorteerbaar.
      },
      currencyColumn: {
        type: 'numericColumn', // Erft alle eigenschappen van `numericColumn`.
        valueFormatter: (params) => formatEuro(params.value), // Specifieke valuta formatter.
      },
      currencyColumnCompact: {
        type: 'numericColumn', // Erft alle eigenschappen van `numericColumn`.
        valueFormatter: (params) => formatEuroCompact(params.value), // Specifieke valuta formatter.
      },
      dateColumn: {
        cellDataType: 'dateString', // Dwingt het datatype af naar 'dateString'.
        filter: 'agDateColumnFilter', // Gebruikt de ingebouwde datumfilter.
        valueFormatter: (params) => params.value ? new Date(params.value).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '', // Formatteert datums en tijden.
        sortable: true, // Datumkolommen zijn sorteerbaar.
      },
      linkColumn: {
        cellRenderer: 'LinkRenderer',
        cellClass: 'link-cell',
      },
      imageColumn: {
        cellRenderer: 'ImageRenderer', // Gebruikt de custom ImageRenderer.
        cellClass: "image-cell", // CSS-klasse voor centreren van inhoud.
      },
    };


    const theme = agGrid.themeQuartz
      .withPart(agGrid.iconSetMaterial)
      .withParams({
        accentColor: "#0E0F0C",
        browserColorScheme: "light",
        fontFamily: { googleFont: "Inter" },
        foregroundColor: "#0E0F0C",
        selectedRowBackgroundColor: 'transparent',
        headerBackgroundColor: "#FFF",
        headerFontSize: 13,
        headerRowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
        iconSize: 13,
        rowHeight: 57,
        rowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
        wrapperBorder: false,
        cellTextColor: "#343433",
        headerTextColor: "#343433",
        wrapperBorderRadius: 0,
        headerColumnResizeHandleColor: "transparent",
        spacing: 8,
        oddRowBackgroundColor: "#FDFCFC",
      });


    // --- Globals & Communicatie ---
    let gridApi = null;
    let currentState = null;
    let pendingSuccessCallback = null;

    function sendRequestToParent(state, action, payload) {
      console.log('d')
        window.parent.postMessage({state, action, payload }, 'https://www-sellerrr-com.filesusr.com');
    }

    // --- Grid Opties ---
    const baseGridOptions = {
      theme,
      defaultColDef,
      columnTypes,
      pagination: true,
      paginationPageSize: 10,
      rowModelType: 'infinite',
      
      paginationPageSizeSelector: [10],
      animateRows: true,
      suppressCellFocus: true,
      undoRedoCellEditing: false,
      undoRedoCellEditingLimit: 5,
      domLayout: "autoHeight",
      loadThemeGoogleFonts: true,
      suppressHorizontalScroll: true,
      suppressNoRowsOverlay: true,
      components: {
        LinkRenderer: LinkRenderer,
        ImageRenderer: ImageRenderer,
      },
    }

    // --- Datasource ---
    function createDatasource() {
      console.log('c')
        return {
            getRows: (params) => {
                pendingSuccessCallback = params.successCallback;
                sendRequestToParent(currentState, 'getGridData', {
                    startRow: params.startRow,
                    endRow: params.endRow,
                    sortModel: params.sortModel,
                    filterModel: params.filterModel,
                });
            },
        };
    }

    // --- State-specifieke Logica ---
    const stateHandlers = {
        resState: {
            extraOptions: {
                rowSelection: { 
                  mode: 'multiRow', 
                  headerCheckbox: false 
                },
                selectionColumnDef: { 
                  headerName: 'Track', 
                  width: 80, 
                  sortable: true ,
                  // cellClassRules: {
                  // 'ag-disabled': p => p.data.isTrackingSyncing === true
                  // }
                },
            },
            listeners: {
                onSortChanged: (p) => p.api.purgeInfiniteCache(),
                onFilterChanged: (p) => p.api.purgeInfiniteCache(),
                onRowSelected: (e) => {
                    sendRequestToParent(currentState, 'trackProduct', {
                        productId: e.node.data.productId,
                        isBeingTracked: e.node.isSelected(),
                    });
                },
            },
        },
        someOtherState: { /* ... */ }
    };

    function applyStateConfig(state) {
      const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};

      /* 4A. Reset – één regel wist ALLE dynamische opties van vorige state */
      [...new Set(Object.values(stateHandlers)
        .flatMap(s => Object.keys(s.extraOptions || {})))]
        .forEach(k => gridApi.setGridOption(k, undefined));

      /* 4B. (Re)bind listeners */
      gridApi.setGridOption('onSortChanged', listeners.onSortChanged);
      gridApi.setGridOption('onFilterChanged', listeners.onFilterChanged);
      gridApi.setGridOption('onRowSelected', listeners.onRowSelected);

      /* 4C. Apply new extra options */
      Object.entries(extraOptions)
        .forEach(([k, v]) => gridApi.setGridOption(k, v));
    }

    // // --- DE KERN: Berichten van de Parent Ontvangen ---
    // window.addEventListener('message', e => {
    //     if (e.origin !== 'https://www-sellerrr-com.filesusr.com') return;

    //     const { action, payload } = e.data;
    //     if (action !== 'updateGrid') return;

    //     const { state, columnDefs, rowData, totalCount } = payload;

    //     if (!gridApi) {
    //         // Grid bestaat niet: bouw hem voor de eerste keer op.
    //         currentState = state;
    //         const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};

    //         gridApi = agGrid.createGrid(document.querySelector('#myGrid'), {
    //             ...baseGridOptions,
    //             ...extraOptions,
    //             ...listeners,
    //             columnDefs,
    //             datasource: createDatasource(),
    //         });

    //         // Eenmalige setup (wheel listener, etc.)
    //         const el = document.querySelector('.ag-center-cols-viewport');
    //         el?.addEventListener('wheel', (e) => {
    //             if (!e.shiftKey && e.deltaY) {
    //                 el.scrollLeft += e.deltaY;
    //                 e.preventDefault();
    //             }
    //         }, { passive: false });

    //     } else {
    //         // Grid bestaat al: verwerk de update.
    //         if (state && state !== currentState) {
    //             currentState = state;
    //             applyStateConfig(state);
    //         }
    //         if (columnDefs) {
    //             gridApi.setGridOption('columnDefs', columnDefs);
    //         }
    //         if (pendingSuccessCallback && rowData) {
    //             pendingSuccessCallback(rowData, totalCount);
    //             pendingSuccessCallback = null;
    //         }
    //         gridApi.hideOverlay();
    //     }
    // });



    window.addEventListener('message', e => {
    if (e.origin !== 'https://www-sellerrr-com.filesusr.com') return;
    const { action, payload } = e.data;
    // --- ACTIE 1: Wix geeft een commando om de state te veranderen ---
    if (action === 'updateGrid') {
        const { state } = payload; // We verwachten alleen de state.
        currentState = state;

        if (!gridApi) {
            console.log('a', e)
            // Grid bestaat niet: bouw een 'lege' grid met de juiste config en datasource.
            // De datasource zal dan ONMIDDELLIJK data opvragen.
            const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};
            gridApi = agGrid.createGrid(document.querySelector('#myGrid'), {
                ...baseGridOptions,
                ...extraOptions,
                ...listeners,
                datasource: createDatasource(),
            });

        } else {
            // Grid bestaat al: update de config en wis de oude data.
            // Dit triggert de datasource om nieuwe data op te halen.
            applyStateConfig(state);
            gridApi.purgeInfiniteCache();
        }
        return; // Taak volbracht.
    }

    // --- ACTIE 2: Wix stuurt de gevraagde data terug ---
    if (action === 'gridDataResponse') {
        console.log('b', e)
        if (!pendingSuccessCallback) return; // Geen openstaand verzoek

        const { columnDefs, rowData, totalCount } = payload;

        // Belangrijk: Update eerst de kolommen, VOORDAT je de rij-data doorgeeft.
        if (columnDefs) {
            gridApi.setGridOption('columnDefs', columnDefs);
        }

        // Geef nu de data aan de grid via de opgeslagen callback.
        pendingSuccessCallback(rowData, totalCount);
        pendingSuccessCallback = null;
        gridApi.hideOverlay();
    }
});


  </script>

</body>

</html>
