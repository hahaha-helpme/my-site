<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />


    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet" />


    <!-- LinkRenderer: cellRenderer voor hyperlink-kolommen -->
    <script src="script/link-renderer.js"></script>

    <!-- ImageRenderer: cellRenderer voor afbeelding-kolommen -->
    <script src="script/image-renderer.js"></script>

    <!-- formatEuroCompact() : compacte €-notatie (K / M) -->
    <script src="script/format-euro-compact.js"></script>

    <!-- formatEuro() : standaard €-notatie met twee decimalen -->
    <script src="script/format-euro.js"></script>

    <!-- showStockChart() : Chart-logica -->
    <script src="script/chart.js"></script>


    <!-- AG Grid + AG Charts -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-charts-community/dist/umd/ag-charts-community.js"></script>


    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        #myGrid {
            overflow-x: auto;
        }

    </style>
</head>


<body>
    <div id="myGrid" style="height: 100%; width: 100%"></div>


    <script>

        const defaultColDef = {
            cellStyle: {
                fontFamily: "Inter, sans-serif",
                fontWeight: "300",
                textAlign: "left",
                fontSize: "13px",
            },
            width: 140,
            resizable: true,
            editable: false,
            filter: true,
            sortable: true,
        }


        const columnTypes = {
            numericColumn: {
                cellDataType: 'number',
                filter: 'agNumberColumnFilter',
                // cellEditor: 'agNumberCellEditor',
                // cellStyle: { textAlign: 'left' }, // Lijn de *getallen in de cellen* rechts uit.
                // headerStyle: { textAlign: 'left' }, // <--- HIER LIJN JE DE *HEADER TEKST* LINKS UIT.
                // editable: true, // Numerieke kolommen zijn standaard bewerkbaar als dit type wordt gebruikt.
                // sortable: true, // Numerieke kolommen zijn sorteerbaar.
            },
            currencyColumn: {
                type: 'numericColumn', // Erft alle eigenschappen van `numericColumn`.
                valueFormatter: (params) => formatEuro(params.value), // Specifieke valuta formatter.
            },
            currencyColumnCompact: {
                type: 'numericColumn', // Erft alle eigenschappen van `numericColumn`.
                valueFormatter: (params) => formatEuroCompact(params.value), // Specifieke valuta formatter.
            },
            dateColumn: {
                cellDataType: 'dateString', // Dwingt het datatype af naar 'dateString'.
                filter: 'agDateColumnFilter', // Gebruikt de ingebouwde datumfilter.
                valueFormatter: (params) => params.value ? new Date(params.value).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '', // Formatteert datums en tijden.
                sortable: true, // Datumkolommen zijn sorteerbaar.
            },
            linkColumn: {
                cellRenderer: 'LinkRenderer',
                cellClass: 'link-cell',
            },
            imageColumn: {
                cellRenderer: 'ImageRenderer', // Gebruikt de custom ImageRenderer.
                cellClass: "image-cell", // CSS-klasse voor centreren van inhoud.
            },
        };


        const theme = agGrid.themeQuartz
            .withPart(agGrid.iconSetMaterial)
            .withParams({
                accentColor: "#0E0F0C",
                browserColorScheme: "light",
                fontFamily: { googleFont: "Inter" },
                foregroundColor: "#0E0F0C",
                selectedRowBackgroundColor: 'transparent',
                headerBackgroundColor: "#FFF",
                headerFontSize: 13,
                headerRowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
                iconSize: 13,
                rowHeight: 57,
                rowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
                wrapperBorder: false,
                cellTextColor: "#343433",
                headerTextColor: "#343433",
                wrapperBorderRadius: 0,
                headerColumnResizeHandleColor: "transparent",
                spacing: 8,
                oddRowBackgroundColor: "#FDFCFC",
            });


        // let gridApi = null;
        // let currentState = null;
        // let wheelAttached = false;

        // /* base grid settings */
        // const baseGridOptions = {
        //     theme,
        //     defaultColDef,
        //     columnTypes,
        //     pagination: true,
        //     paginationPageSize: 10,
        //     paginationPageSizeSelector: [10],
        //     animateRows: true,
        //     suppressCellFocus: true,
        //     undoRedoCellEditing: false,
        //     undoRedoCellEditingLimit: 5,
        //     domLayout: "autoHeight",
        //     loadThemeGoogleFonts: true,
        //     suppressHorizontalScroll: true,
        //     suppressNoRowsOverlay: true,
        //     components: {
        //         LinkRenderer: LinkRenderer,
        //         ImageRenderer: ImageRenderer,
        //     },

        // };

        // /* this object is reused for every state */
        // const gridOptions = { ...baseGridOptions };


        // function requestDataFromServer() {
        //     if (!gridApi) return;
        //     gridApi.showLoadingOverlay();

        //     const request = {
        //         sortModel: gridApi.getSortModel(),
        //         filterModel: gridApi.getFilterModel(),
        //         pageNumber: gridApi.paginationGetCurrentPage(),
        //         pageSize: PAGE_SIZE,
        //     };

        //     // Stuur de aanvraag naar de parent (Wix)
        //     sendToWix('fetchGridData', request);
        // }

        // /* per-state tweaks and handlers */
        // const stateHandlers = {
        //         resState: {
        //             extraOptions: { 
        //                 rowSelection: { 
        //                     mode: 'multiRow',
        //                     headerCheckbox: false, 
        //                 },
        //                 selectionColumnDef: {
        //                     headerName: 'Track',
        //                     width: 80,
        //                     sortable: true,
        //                 },
        //             },
        //             onCellClicked: (e) => {
        //                 console.log('e.data', e.data)
        //                 //sendToWix('cellClicked', e.data);
        //                 //showStockChart(e.data);
        //             },
        //             onRowSelected: (event) => {
        //                 console.log('Rij geselecteerd:', event.node.data);
        //                 console.log('Is geselecteerd:', event.node.isSelected());
        //             },
        //             onRowSelected: requestDataFromServer(event),
        //             onSortChanged: requestDataFromServer(event),
        //             onFilterChanged: requestDataFromServer(event),
        //             onPaginationChanged: requestDataFromServer(event),
        //         },
        //         someOtherState: {
        //             extraOptions: {
        //                 singleClickEdit: true,
        //                 suppressRowClickSelection: true
        //             },
        //             onRowClicked: (e) => {
        //                 sendToWix('rowClicked', e.data);
        //                 e.api.startEditingCell({ rowIndex: e.rowIndex, colKey: 'price' });
        //             }
        //     }
        // };

        // function applyState(state) {
        //     const h = stateHandlers[state] || {};
        //     Object.assign(gridOptions, baseGridOptions, h.extraOptions || {});

        //     /* eight explicit event bindings */
        //     gridOptions.onRowClicked       = h.onRowClicked       || null;
        //     gridOptions.onCellClicked      = h.onCellClicked      || null;
        //     gridOptions.onRowSelected      = h.onRowSelected      || null;
        //     gridOptions.onColumnResized    = h.onColumnResized    || null;
        //     gridOptions.onSortChanged      = h.onSortChanged      || null;
        //     gridOptions.onFilterChanged    = h.onFilterChanged    || null;
        // }

        // window.addEventListener("message", (e) => {
        //     if (e.origin !== "https://www-sellerrr-com.filesusr.com") return;
        //     const { action, payload } = e.data;
        //     if (action !== "updateState") return;

        //     const { state, columnDefs, rowData } = payload;
        //     currentState = state;

        //     applyState(state);
        //     if (!gridApi) gridApi = agGrid.createGrid(document.querySelector("#myGrid"), gridOptions);
        //     if (columnDefs) gridApi.setGridOption("columnDefs", payload.columnDefs);
        //     if (rowData)    gridApi.setGridOption("rowData", payload.rowData);

        //     gridApi.refreshCells();

        //     if (!wheelAttached) {
        //         const el = document.querySelector('.ag-center-cols-viewport');
        //         el?.addEventListener('wheel', (e) => {
        //             if (!e.shiftKey && e.deltaY) {
        //                 el.scrollLeft += e.deltaY;
        //                 e.preventDefault();
        //             }
        //         }, { passive: false });
        //     }
        // });

        // function sendToWix(action, payload) {
        //     window.parent.postMessage({ action, payload }, "https://www-sellerrr-com.filesusr.com");
        // }


        /* ==========================================================
 *  Dynamic AG Grid setup with per-state options & listeners
 *  – Community Edition, single-instance pattern            *
 * ========================================================== */

/* ---------- 0.  Utils ---------- */
function dispatchGridAction(action, payload) {
  window.parent.postMessage(
    { action, state: currentState, payload },
    'https://www-sellerrr-com.filesusr.com'
  );
}

/* ---------- 1.  Globals ---------- */
let   gridApi      = null;
let   currentState = null;
const PAGE_SIZE    = 10;
let wheelAttached = false;

/* ---------- 2.  Base grid options (never change) ---------- */
const baseGridOptions = {
    theme,
    defaultColDef,
    columnTypes,
    pagination: true,
    paginationPageSize: 10,
    paginationPageSizeSelector: [10],
    animateRows: true,
    suppressCellFocus: true,
    undoRedoCellEditing: false,
    undoRedoCellEditingLimit: 5,
    domLayout: "autoHeight",
    loadThemeGoogleFonts: true,
    suppressHorizontalScroll: true,
    suppressNoRowsOverlay: true,
    components: {
        LinkRenderer: LinkRenderer,
        ImageRenderer: ImageRenderer,
    },
}

/* ---------- 3.  Per-state config (“brains” of the app) ---------- */
const stateHandlers = {
  stockState: {
    extraOptions: {

                                rowSelection: { 
                            mode: 'multiRow',
                            headerCheckbox: false, 
                        },
                        selectionColumnDef: {
                            headerName: 'Track',
                            width: 80,
                            sortable: true,
                        },
      rowSelection: {
        mode: 'multiple',
        headerCheckbox: false 
        },
      rowSelectionColumn: {          // vervangt selectionColumnDef
        headerName: 'Track',
        width: 80,
        sortable: true,
        // cellClassRules: {
        //   'ag-disabled': p => p.data.isTrackingSyncing === true
        // }
      }
    },
    listeners: {
      onSortChanged: p => {
        gridApi.showLoadingOverlay();
        dispatchGridAction('gridStateChanged', {
          sortModel:   p.api.getSortModel(),
          filterModel: p.api.getFilterModel(),
          pageNumber:  p.api.paginationGetCurrentPage()
        });
      },
      onFilterChanged: p => {
        gridApi.showLoadingOverlay();
        p.api.paginationGoToFirstPage();
        dispatchGridAction('gridStateChanged', {
          sortModel:   p.api.getSortModel(),
          filterModel: p.api.getFilterModel(),
          pageNumber:  0
        });
      },
    //   onPaginationChanged: e => {
    //     if (e.newData) return; // alleen paginawissel door gebruiker
    //     gridApi.showLoadingOverlay();
    //     dispatchGridAction('gridStateChanged', {
    //       sortModel:   e.api.getSortModel(),
    //       filterModel: e.api.getFilterModel(),
    //       pageNumber:  e.api.paginationGetCurrentPage()
    //     });
    //   },
      onRowSelected: e => {
        dispatchGridAction('trackProduct', {
          productId:      e.node.data.productId,
          isBeingTracked: e.node.isSelected()
        });
      }
    }
  },

  /* --- 3.2  Another simple state ------------------------------- */
  someOtherState: {
    extraOptions: { rowSelection: 'multiple' },
    listeners:    {} // géén server calls, dus leeg
  }
}

/* ---------- 4.  Apply per-state config to an existing grid ---------- */
function applyStateConfig(state) {
  const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};

  /* 4A. Reset – één regel wist ALLE dynamische opties van vorige state */
  [...new Set(Object.values(stateHandlers)
          .flatMap(s => Object.keys(s.extraOptions || {})))]
      .forEach(k => gridApi.setGridOption(k, undefined));

  /* 4B. (Re)bind listeners */
  gridApi.setGridOption('onSortChanged',       listeners.onSortChanged);
  gridApi.setGridOption('onFilterChanged',     listeners.onFilterChanged);
  gridApi.setGridOption('onPaginationChanged', listeners.onPaginationChanged);
  gridApi.setGridOption('onRowSelected',       listeners.onRowSelected);

  /* 4C. Apply new extra options */
  Object.entries(extraOptions)
        .forEach(([k, v]) => gridApi.setGridOption(k, v));
}

/* ---------- 5.  postMessage listener (entry-point from parent) ---------- */
window.addEventListener('message', e => {
  if (e.origin !== 'https://www-sellerrr-com.filesusr.com') return;
  const { action, payload } = e.data;
  if (action !== 'updateGrid') return;

  const { state, columnDefs, rowData, totalCount } = payload;

  /* 5A. First-time initialisation -------------------------------- */
  if (!gridApi) {
    currentState = state;
    const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};
    gridApi = agGrid.createGrid(
      document.querySelector('#myGrid'),
      {
        ...baseGridOptions,
        ...extraOptions,
        ...listeners,
        columnDefs,   // meegeven voorkomt “No Rows”-flits
        rowData
      }
    );

        if (!wheelAttached) {
    const el = document.querySelector('.ag-center-cols-viewport');
    el?.addEventListener('wheel', (e) => {
        if (!e.shiftKey && e.deltaY) {
            el.scrollLeft += e.deltaY;
            e.preventDefault();
        }
    }, { passive: false });
}


  }

  /* 5B. Existing grid: switch state or just refresh -------------- */
  else {
    if (state !== currentState) {
      currentState = state;
      applyStateConfig(state);
    }
    if (columnDefs) gridApi.setGridOption('columnDefs', columnDefs);
    if (rowData)    gridApi.setGridOption('rowData',    rowData);
  }

  /* 5C. Always update total rows & hide overlay ------------------ */
  if (typeof totalCount === 'number') gridApi.setGridOption('paginationTotalRowCount', totalCount);

  gridApi.hideOverlay();
});


    </script>
</body>

</html>