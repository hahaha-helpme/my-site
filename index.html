<!DOCTYPE html>
<html lang="nl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet" />


  <!-- LinkRenderer: cellRenderer voor hyperlink-kolommen -->
  <script src="script/link-renderer.js"></script>

  <!-- ImageRenderer: cellRenderer voor afbeelding-kolommen -->
  <script src="script/image-renderer.js"></script>

  <!-- formatEuroCompact() : compacte €-notatie (K / M) -->
  <script src="script/format-euro-compact.js"></script>

  <!-- formatEuro() : standaard €-notatie met twee decimalen -->
  <script src="script/format-euro.js"></script>

  <!-- showStockChart() : Chart-logica -->
  <script src="script/chart.js"></script>


  <!-- AG Grid + AG Charts -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ag-charts-community/dist/umd/ag-charts-community.js"></script>


  <style>
    html,
    body { margin: 0; padding: 0; }

    #myGrid { overflow-x: auto; }


    .ag-simple-filter-body-wrapper {
      padding: 12px 12px 0px 12px !important;
    }

    .ag-filter-apply-panel {
      display: flex;
      justify-content: flex-end;
      gap: 8px !important;
      padding: 0px 12px 12px 12px !important;
      --ag-font-size: 13px;
    }

    .ag-filter-apply-panel-button {
      margin-left: 0px;
    }

    .ag-filter-apply-panel .ag-button:hover {
      background-color: transparent !important;
      color: inherit !important;
    }

    /* Of gebruik CSS custom properties */
    .ag-filter-apply-panel {
      --ag-button-hover-background-color: transparent;
      --ag-button-hover-color: inherit;
    }
  </style>
</head>


<body>
  <div id="myGrid" style="height: 100%; width: 100%"></div>


  <script>

    const defaultColDef = {
      cellStyle: {
        fontFamily: "Inter, sans-serif",
        fontWeight: "300",
        textAlign: "left",
        fontSize: "13px",
      },
      width: 140,
      resizable: true,
      editable: false,
      sortable: true,
    }


    const columnTypes = {
      customTextColumn: {
        cellDataType: 'text',
        filter: "agTextColumnFilter",
        filterParams: {
          buttons: ['apply', 'reset'],
          closeOnApply: true,
          filterOptions: ['contains', 'notContains', 'equals', 'notEqual', 'startsWith', 'endsWith'],
          maxNumConditions: 1,
          trimInput: true,
        }
      },
      customNumericColumn: {
        cellDataType: 'number',
        filter: 'agNumberColumnFilter',
        filterParams: {
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: ['equals', 'notEqual', 'greaterThan', 'greaterThanOrEqual', 'lessThan', 'lessThanOrEqual', 'inRange', 'blank', 'notBlank',],
        }
      },
      customCurrencyColumn: {
        type: 'numericColumn', // Erft alle eigenschappen van `numericColumn`.
        filter: 'agNumberColumnFilter',
        filterParams: {
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: [ 'equals', 'notEqual', 'greaterThan', 'greaterThanOrEqual', 'lessThan', 'lessThanOrEqual', 'inRange', 'blank', 'notBlank', ],
        },
        valueFormatter: (params) => formatEuro(params.value), // Specifieke valuta formatter.
      },
      customCurrencyColumnCompact: {
        type: 'numericColumn', // Erft alle eigenschappen van `numericColumn`.
        filter: 'agNumberColumnFilter',
        filterParams: {
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: [ 'equals', 'notEqual', 'greaterThan', 'greaterThanOrEqual', 'lessThan', 'lessThanOrEqual', 'inRange', 'blank', 'notBlank', ],
        },
        valueFormatter: (params) => formatEuroCompact(params.value), // Specifieke valuta formatter.
      },
      customDateColumn: {
        cellDataType: 'dateString', // Dwingt het datatype af naar 'dateString'.
        filter: 'agDateColumnFilter',
        filterParams: {
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: [ 'equals', 'notEqual', 'lessThan', 'greaterThan', 'inRange', 'blank', 'notBlank' ],
        },
        valueFormatter: (params) => params.value ? new Date(params.value).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '', // Formatteert datums en tijden.

      },
      customLinkColumn: {
        cellRenderer: 'LinkRenderer',
        cellClass: 'link-cell',
      },
      customImageColumn: {
        cellRenderer: 'ImageRenderer', // Gebruikt de custom ImageRenderer.
        cellClass: "image-cell", // CSS-klasse voor centreren van inhoud.
        filter: false,
        sortable: false,
      },
    };


    const theme = agGrid.themeQuartz
      .withPart(agGrid.iconSetMaterial)
      .withParams({
        accentColor: "#0E0F0C",
        browserColorScheme: "light",
        fontFamily: { googleFont: "Inter" },
        foregroundColor: "#0E0F0C",
        selectedRowBackgroundColor: 'transparent',
        headerBackgroundColor: "#FFF",
        headerFontSize: 13,
        headerRowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
        iconSize: 13,
        rowHeight: 57,
        rowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
        wrapperBorder: false,
        cellTextColor: "#343433",
        headerTextColor: "#343433",
        wrapperBorderRadius: 0,
        headerColumnResizeHandleColor: "transparent",
        spacing: 8,
        oddRowBackgroundColor: "#FDFCFC",

        // properties die ik al verzameld heb.
        // menuBackgroundColor: '#F2F2F2',        // Achtergrondkleur van de popup
        // menuTextColor: '#181d1f',              // Algemene tekstkleur
        // menuShadow: '0 0px 0px rgba(0,0,0,0.15)', // Schaduw van de popup
        menuBorder: '0px solid #d9dcde',       // Rand rond de popup
        // menuSeparatorColor: '#d9dcde',         // Kleur van de scheidingslijntjes
        // borderRadius: 8,                       // Afronding van de hoeken (in pixels)
        // inputBackgroundColor: '#ffffff',       // Achtergrond van tekstvelden
        // inputBorderColor: '#d9dcde',           // Randkleur van tekstvelden
        // inputFocusBorderColor: '#007bff',      // Randkleur bij focus (als je erin klikt)
        // inputFocusShadow: '0 0 0 1px rgba(0, 123, 255, 0.25)', // Schaduw bij focus
        // inputPlaceholderTextColor: '#999',     // Kleur van de placeholder tekst
        menuBackgroundColor: '#F2F2F2',
        borderColor: '#F2F2F2',
        inputTextColor: '#454745', // Kleur van de tekst in invoervelden
        inputPlaceholderTextColor: '#454745', // Placeholder tekstkleur
        buttonPillBackgroundColor: '#ffffff',
        buttonHoverBackgroundColor: 'transparent',


        // // === Main Container Parameters ===
        // backgroundColor: '#ffffff', // Achtergrondkleur van het hele filter popup
        // borderColor: '#dee2e6', // Randkleur van het popup
        // borderRadius: 8, // Afgeronde hoeken van het filter popup
        // cardShadow: '0 4px 12px rgba(0, 0, 0, 0.1)', // Schaduw rondom de popup
        // spacing: 12, // Interne ruimte tussen elementen

        // // === Input Fields - Default State ===
        // inputBackgroundColor: '#f8f9fa', // Achtergrond van invoervelden
        // inputBorder: { width: 1, style: 'solid', color: '#ced4da' }, // Volledige randstijl van inputs
        // inputBorderColor: '#ced4da', // Kleur van de rand van invoervelden
        // inputTextColor: '#212529', // Kleur van de tekst in invoervelden
        // inputPlaceholderTextColor: '#6c757d', // Placeholder tekstkleur
        // inputIconColor: '#495057', // Kleur van iconen in invoervelden

        // // === Input Fields - Focus State ===
        // inputFocusBorderColor: '#0d6efd', // Randkleur bij focus
        // inputFocusShadow: '0 0 0 0.25rem rgba(13, 110, 253, 0.25)', // Schaduw bij focus

        // // === Buttons ===
        // accentColor: '#0d6efd', // Accentkleur (primair voor apply-button)
        // foregroundColor: '#ffffff', // Tekstkleur voor primaire knoppen
        // buttonBorderRadius: 4, // Afronding van knoppen
        // buttonPillBackgroundColor: '#e9ecef', // Achtergrondkleur voor pill-style knoppen
        // buttonPillTextColor: '#495057', // Tekstkleur voor pill-style knoppen

        // // === Layout and Spacing ===
        // listItemHeight: 28, // Hoogte van dropdown opties
        // widgetVerticalSpacing: 8, // Verticale afstand tussen widgets
        // widgetHorizontalSpacing: 12, // Horizontale afstand tussen widgets

        // // === Filter-Specific ===
        // filterPanelApplyButtonBackgroundColor: '#0d6efd', // Achtergrondkleur van de 'Apply' knop in filter panel
        // filterPanelApplyButtonColor: '#ffffff', // Tekstkleur van de 'Apply' knop in filter panel
        // iconButtonActiveBackgroundColor: '#e7f3ff', // Achtergrondkleur van actieve filter iconen
        // iconButtonActiveColor: '#0d6efd' // Kleur van actieve filter iconen
      });


    // --- Globals & Communicatie ---
    let gridApi = null;
    let currentState = null;
    let pendingSuccessCallback = null;
    let wheelAttached = false;

    function sendRequestToParent(state, action, payload) {
      window.parent.postMessage({ state, action, payload }, 'https://www-sellerrr-com.filesusr.com');
    }

    // --- Grid Opties ---
    const baseGridOptions = {
      theme,
      defaultColDef,
      columnTypes,
      pagination: true,
      paginationPageSize: 10,
      rowModelType: 'infinite',
      cacheBlockSize: 10,

      paginationPageSizeSelector: [10],
      animateRows: true,
      suppressCellFocus: true,
      undoRedoCellEditing: false,
      undoRedoCellEditingLimit: 5,
      domLayout: "autoHeight",
      loadThemeGoogleFonts: true,
      suppressHorizontalScroll: true,
      suppressNoRowsOverlay: true,
      components: {
        LinkRenderer: LinkRenderer,
        ImageRenderer: ImageRenderer,
      },

      localeText: {
        applyFilter: 'Apply filter',
        resetFilter: 'Remove filter',
      },
    }

    // --- Datasource ---
    function createDatasource() {
      return {
        getRows: (params) => {
          pendingSuccessCallback = params.successCallback;
          sendRequestToParent(currentState, 'getGridData', {
            offset: params.startRow,
            limit: params.endRow - params.startRow,
            sort: params.sortModel,
            filter: params.filterModel,
          });
        },
      };
    }

    // --- State-specifieke Logica ---
    const stateHandlers = {
      resState: {
        extraOptions: {
          rowSelection: {
            mode: 'multiRow',
            headerCheckbox: false
          },
          selectionColumnDef: {
            headerName: 'Track',
            width: 80,
            sortable: true,
            // cellClassRules: {
            // 'ag-disabled': p => p.data.isTrackingSyncing === true
            // }
          },
        },
        listeners: {
          onSortChanged: (p) => p.api.purgeInfiniteCache(),
          onFilterChanged: (p) => p.api.purgeInfiniteCache(),
          onRowSelected: (e) => {
            sendRequestToParent(currentState, 'trackProduct', {
              productId: e.node.data.productId,
              rowSelected: e.node.isSelected(),
            });
          },
        },
      },
      someOtherState: { /* ... */ }
    };

    function applyStateConfig(state) {
      const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};

      /* 4A. Reset – één regel wist ALLE dynamische opties van vorige state */
      [...new Set(Object.values(stateHandlers)
        .flatMap(s => Object.keys(s.extraOptions || {})))]
        .forEach(k => gridApi.setGridOption(k, undefined));

      /* 4B. (Re)bind listeners */
      gridApi.setGridOption('onSortChanged', listeners.onSortChanged);
      gridApi.setGridOption('onFilterChanged', listeners.onFilterChanged);
      gridApi.setGridOption('onRowSelected', listeners.onRowSelected);

      /* 4C. Apply new extra options */
      Object.entries(extraOptions)
        .forEach(([k, v]) => gridApi.setGridOption(k, v));
    }

    window.addEventListener('message', e => {
      if (e.origin !== 'https://www-sellerrr-com.filesusr.com') return;
      const { action, payload } = e.data;
      // --- ACTIE 1: Wix geeft een commando om de state te veranderen ---
      if (action === 'initGrid') {
        const { state } = payload; // We verwachten alleen de state.
        currentState = state;

        if (!gridApi) {
          // Grid bestaat niet: bouw een 'lege' grid met de juiste config en datasource.
          // De datasource zal dan ONMIDDELLIJK data opvragen.
          const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};
          gridApi = agGrid.createGrid(document.querySelector('#myGrid'), {
            ...baseGridOptions,
            ...extraOptions,
            ...listeners,
            columnDefs: [],
            datasource: createDatasource(),
          });

          if (!wheelAttached) {
            const el = document.querySelector('.ag-center-cols-viewport');
            el?.addEventListener('wheel', (e) => {
              if (!e.shiftKey && e.deltaY) {
                el.scrollLeft += e.deltaY;
                e.preventDefault();
              }
            }, { passive: false });
          }

        } else {
          // Grid bestaat al: update de config en wis de oude data.
          // Dit triggert de datasource om nieuwe data op te halen.
          applyStateConfig(state);
          gridApi.purgeInfiniteCache();
        }
        return; // Taak volbracht.
      }

      // --- ACTIE 2: Wix stuurt de gevraagde data terug ---
      if (action === 'gridDataResponse') {
        if (!pendingSuccessCallback) return; // Geen openstaand verzoek

        const { columnDefs, rowData, totalCount } = payload;

        // Belangrijk: Update eerst de kolommen, VOORDAT je de rij-data doorgeeft.
        if (columnDefs) {
          gridApi.setGridOption('columnDefs', columnDefs);
        }

        // Geef nu de data aan de grid via de opgeslagen callback.
        pendingSuccessCallback(rowData, totalCount);
        pendingSuccessCallback = null;
        gridApi.hideOverlay();
      }
    });


  </script>

</body>

</html>