<!DOCTYPE html>
<html lang="nl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet" />


  <!-- LinkRenderer: cellRenderer voor hyperlink-kolommen -->
  <script src="script/link-renderer.js"></script>

  <!-- ImageRenderer: cellRenderer voor afbeelding-kolommen -->
  <script src="script/image-renderer.js"></script>

  <!-- formatCurrencyCompact() : compacte €-notatie (K / M) -->
  <script src="script/format-currency-compact.js"></script>

  <!-- formatCurrency() : standaard €-notatie met twee decimalen -->
  <script >(function () {
  const currencies = {
    sk: 'EUR',
    pl: 'PLN',
    de: 'EUR',
    at: 'EUR',
    cz: 'CZK'
  };

  window.formatCurrencyCompact = function (value, countryCode) {
    if (value == null) return '';
    const currency = currencies[countryCode] || 'EUR';
    const formatted = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency,
      notation: 'compact',
      compactDisplay: 'short',
      minimumFractionDigits: value < 1000 ? 2 : 0,
      maximumFractionDigits: value < 1000 ? 2 : 1
    }).format(value);
    return formatted.replace('.', ',');
  };
})();</script>

  <!-- showStockChart() : Chart-logica -->
  <script >// chart.js

(function () {
    // CSS wordt één keer gedefinieerd en toegevoegd voor een consistente styling.
    const style = document.createElement("style");
    style.textContent = `
      .chart-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; max-width: 90vw; height: 500px; max-height: 80vh; background-color: #f2f2f2; border-radius: 8px; z-index: 1000; display: flex; flex-direction: column; font-family: "Inter", sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
      .chart-popup-header { padding: 16px 20px; cursor: move; background-color: #f2f2f2; display: flex; justify-content: space-between; align-items: center; border-top-left-radius: 8px; border-top-right-radius: 8px; }
      .chart-popup-title { font-weight: 600; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .chart-popup-close { cursor: pointer; border: none; background: none; font-size: 24px; font-weight: bold; color: #555; line-height: 1; }
      .chart-popup-close:hover { color: black; }
      .chart-popup-controls { padding: 5px 20px; display: flex; gap: 16px; background-color: #f2f2f2; }
      .chart-popup-controls select { font-family: "Inter", sans-serif; padding: 6px 10px; border-radius: 4px; background-color: white; border: 0px;}
      .chart-popup-content { flex-grow: 1; padding: 10px 20px 20px 20px; }`;
    document.head.appendChild(style);

    function removeExistingChartPopup() {
        const existing = document.querySelector(".chart-popup");
        if (existing) existing.remove();
    }

    // De centrale, herbruikbare functie voor het renderen van grafieken.
    window.renderChart = function (columnId, rowNode) {
        removeExistingChartPopup();
        const { data: productData } = rowNode;
        if (!productData?.offers?.length) return; // Vroege return als er geen data is

        // --- Stap 1: Bouw de popup-structuur efficiënt met een template ---
        const popup = document.createElement("div");
        popup.className = "chart-popup";

        const sellers = [...new Map(productData.offers.map(o => [o.sellerId, o.sellerName])).entries()];
        const sellerOptions = sellers.map(([id, name]) => `<option value="${id}">${name}</option>`).join('');

        popup.innerHTML = `
            <div class="chart-popup-header">
                <span class="chart-popup-title"></span>
                <button class="chart-popup-close">×</button>
            </div>
            <div class="chart-popup-controls">
                <select id="period-select">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <select id="seller-select">
                    <option value="all">All Sellers</option>
                    ${sellerOptions}
                </select>
            </div>
            <div class="chart-popup-content" id="chart-container-${productData.productId}"></div>`;
        
        document.body.appendChild(popup);

        // --- Stap 2: Verkrijg referenties naar de interactieve elementen ---
        const ui = {
            header: popup.querySelector('.chart-popup-header'),
            title: popup.querySelector('.chart-popup-title'),
            closeButton: popup.querySelector('.chart-popup-close'),
            periodSelect: popup.querySelector('#period-select'),
            sellerSelect: popup.querySelector('#seller-select'),
            chartContainer: popup.querySelector('.chart-popup-content'),
        };

        let chartInstance = null;

        // --- Stap 3: Definieer de update-logica die data verwerkt en de grafiek bijwerkt ---
        const updateChart = () => {
            const selectedPeriod = ui.periodSelect.value;
            const selectedSellerId = ui.sellerSelect.value;

            // Dataverwerking: filteren en aggregeren
            const filteredOffers = selectedSellerId === 'all'
                ? productData.offers
                : productData.offers.filter(o => o.sellerId === selectedSellerId);

            const getPeriodKey = (timestamp) => {
                const d = new Date(timestamp);
                if (selectedPeriod === 'weekly') {
                    const tempDate = new Date(d);
                    const day = tempDate.getDay();
                    const diff = tempDate.getDate() - day + (day === 0 ? -6 : 1);
                    const weekStart = new Date(tempDate.setDate(diff));
                    return weekStart.toISOString().split('T')[0];
                }
                if (selectedPeriod === 'monthly') {
                    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                }
                return d.toISOString().split('T')[0]; // Daily
            };

            const aggregated = [...filteredOffers.reduce((map, offer) => {
                const key = getPeriodKey(offer.scrapeTimestamp);
                const entry = map.get(key) || { 
                    revenue: 0, unitsSold: 0, priceSum: 0, sellers: new Set(), date: key,
                    deliveryRateSum: 0, stockLeftSum: 0, deliveryTimeMinSum: 0,
                    deliveryTimeMaxSum: 0, buyBoxCount: 0, offerCount: 0 
                };
                
                entry.revenue += Number(offer.revenue) || 0;
                entry.unitsSold += Number(offer.unitsSold) || 0;
                entry.priceSum += Number(offer.price) || 0;
                entry.sellers.add(offer.sellerId); // HIER WORDT DE VERKOPER GETELD

                entry.deliveryRateSum += Number(offer.deliveryRate) || 0;
                entry.stockLeftSum += Number(offer.stockLeft) || 0;
                entry.deliveryTimeMinSum += Number(offer.deliveryTimeRangeDaysMin) || 0;
                entry.deliveryTimeMaxSum += Number(offer.deliveryTimeRangeDaysMax) || 0;
                if (offer.buyBox) {
                    entry.buyBoxCount++;
                }
                entry.offerCount++;
                
                return map.set(key, entry);
            }, new Map()).values()].sort((a,b) => new Date(a.date) - new Date(b.date));


            // Mapping naar grafiekdata op basis van gekozen kolom
            const columnMapping = {
                'revenue': d => d.revenue,
                'unitsSold': d => d.unitsSold,
                'avgWeightedPrice': d => d.offerCount > 0 ? d.priceSum / d.offerCount : 0,
                'sellerCount': d => d.sellers.size, // HIER WORDT DE WAARDE GEMAPT
                'deliveryRate': d => d.offerCount > 0 ? d.deliveryRateSum / d.offerCount : 0,
                'stockLeft': d => d.offerCount > 0 ? d.stockLeftSum / d.offerCount : 0,
                'deliveryTimeMin': d => d.offerCount > 0 ? d.deliveryTimeMinSum / d.offerCount : 0,
                'deliveryTimeMax': d => d.offerCount > 0 ? d.deliveryTimeMaxSum / d.offerCount : 0,
                'buyBox': d => d.buyBoxCount,
            };

            const chartData = aggregated.map(d => ({
                date: new Date(d.date).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                value: Number((columnMapping[columnId] || (() => 0))(d).toFixed(2))
            }));

            // Grafiekopties voorbereiden
            const yAxisTitle = columnId.charAt(0).toUpperCase() + columnId.slice(1).replace(/([A-Z])/g, ' $1');
            ui.title.textContent = `${yAxisTitle} for: ${productData.productTitle}`;
            
            const chartOptions = {
                data: chartData,
                series: [{ type: "bar", xKey: "date", yKey: "value", yName: yAxisTitle }],
                axes: [
                    { type: "category", position: "bottom", title: { text: "Date" } },
                    { type: "number", position: "left", title: { text: yAxisTitle } }
                ],
                legend: { enabled: false },
                background: { fill: "#f2f2f2" },
            };
            
            // --- Stap 4: Creëer de grafiek (indien nodig) of werk hem bij ---
            if (!chartInstance) {
                chartOptions.container = ui.chartContainer;
                chartInstance = agCharts.AgCharts.create(chartOptions);
            } else {
                chartInstance.update(chartOptions);
            }
        };

        // --- Stap 5: Voeg event listeners en drag-functionaliteit toe ---
        ui.periodSelect.addEventListener("change", updateChart);
        ui.sellerSelect.addEventListener("change", updateChart);
        ui.closeButton.addEventListener("click", () => popup.remove());

        let isDragging = false, offsetX, offsetY;
        ui.header.onmousedown = (e) => {
            isDragging = true;
            offsetX = e.clientX - popup.offsetLeft;
            offsetY = e.clientY - popup.offsetTop;
        };
        document.onmousemove = (e) => {
            if (!isDragging) return;
            popup.style.left = `${e.clientX - offsetX}px`;
            popup.style.top = `${e.clientY - offsetY}px`;
        };
        document.onmouseup = () => isDragging = false;

        updateChart(); // Eerste render
    };
})();</script>


  <!-- AG Grid + AG Charts -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@34.0.2/dist/ag-grid-community.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ag-charts-community@12.0.2/dist/umd/ag-charts-community.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    #myGrid {
      overflow-x: auto;
    }

    /* Ingesteld voor popup/menu van filter */
    .ag-simple-filter-body-wrapper {
      padding: 12px 12px 0px 12px !important;
    }

    /* Ingesteld voor popup/menu van filter */
    .ag-filter-apply-panel {
      display: flex;
      justify-content: flex-end;
      gap: 8px !important;
      padding: 0px 12px 12px 12px !important;
    }

    /* Ingesteld voor popup/menu van filter */
    .ag-filter-apply-panel-button {
      margin-left: 0px;
    }

    /* Ingesteld voor popup/menu van filter */
    .ag-filter-body-wrapper {
      --ag-font-size: 13px;
    }

    /* Ingesteld voor popup/menu van filter */
    .ag-filter {
      font-size: 13px;
    }
  </style>
</head>


<body>
  <div id="myGrid" style="height: 100%; width: 100%"></div>


  <script>
    const defaultColDef = {
      cellStyle: {
        fontFamily: "Inter, sans-serif",
        fontWeight: "300",
        textAlign: "left",
        fontSize: "13px",
      },
      width: 140,
      resizable: true,
      editable: false,
      sortable: true,
    }


    const columnTypes = {
      customTextColumn: {
        cellDataType: 'text',
        filter: "agTextColumnFilter",
        filterParams: {
          buttons: ['apply', 'reset'],
          closeOnApply: true,
          filterOptions: ['contains', 'notContains', 'equals', 'notEqual', 'startsWith', 'endsWith', 'blank', 'notBlank'],
          maxNumConditions: 1,
          trimInput: true,
        }
      },
      customNumericColumn: {
        cellDataType: 'number',
        filter: 'agNumberColumnFilter',
        filterParams: {
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: ['equals', 'notEqual', 'greaterThan', 'greaterThanOrEqual', 'lessThan', 'lessThanOrEqual', 'inRange', 'blank', 'notBlank'],
        }
      },
      customCurrencyColumn: {
        cellDataType: 'number',
        filter: 'agNumberColumnFilter',
        filterParams: {
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: ['equals', 'notEqual', 'greaterThan', 'greaterThanOrEqual', 'lessThan', 'lessThanOrEqual', 'inRange', 'blank', 'notBlank'],
        },
        // valueFormatter: (params) => formatEuro(params.value), // Specifieke valuta formatter.
        valueFormatter: (params) => {
          const countryCode = (params?.data?.productHostname || 'kaufland.de').slice(-2);
          return formatCurrency(params.value, countryCode); // Daarna gewoon de waarde formatteren
        }
      },
      customCurrencyColumnCompact: {
        cellDataType: 'number',
        filter: 'agNumberColumnFilter',
        filterParams: {
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: ['equals', 'notEqual', 'greaterThan', 'greaterThanOrEqual', 'lessThan', 'lessThanOrEqual', 'inRange', 'blank', 'notBlank'],
        },
        // valueFormatter: (params) => formatEuroCompact(params.value), // Specifieke valuta formatter.
        valueFormatter: (params) => {
          const countryCode = (params?.data?.productHostname || 'kaufland.de').slice(-2);
          return formatCurrencyCompact(params.value, countryCode); // Daarna gewoon de waarde formatteren
        }

      },
      customDateColumn: {
        cellDataType: 'dateString', // Dwingt het datatype af naar 'dateString'.
        filter: 'agDateColumnFilter',
        filterParams: {
          browserDatePicker: true,
          buttons: ['apply', 'reset'],
          maxNumConditions: 1,
          trimInput: true,
          closeOnApply: true,
          filterOptions: ['equals', 'notEqual', 'lessThan', 'greaterThan', 'inRange', 'blank', 'notBlank'],
        },
        valueFormatter: (params) => params.value ? new Date(params.value).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '', // Formatteert datums en tijden.

      },
      customLinkColumn: {
        cellRenderer: 'LinkRenderer',
        cellClass: 'link-cell',
        sortable: false,
      },
      customImageColumn: {
        cellRenderer: 'ImageRenderer',
        cellClass: "image-cell",
        filter: false,
        sortable: false,
      },
      customCheckboxColumn: {
        cellRenderer: 'agCheckboxCellRenderer',
        cellEditor: 'agCheckboxCellEditor',
        editable: true,
        filter: 'agNumberColumnFilter',
        filterParams: {
          closeOnApply: true,
          buttons: ['apply', 'reset'],
          defaultOption: 'true-and-false',
          filterOptions: [
            {
              displayKey: 'true-and-false',
              displayName: 'All',
              predicate: () => true,
              numberOfInputs: 0,
            },
            {
              displayKey: 'true',
              displayName: 'Tracking Enabled',
              predicate: (_, value) => value === true,
              numberOfInputs: 0,
            },
            {
              displayKey: 'false',
              displayName: 'Tracking Disabled',
              predicate: (_, value) => value === false,
              numberOfInputs: 0,
            }
          ],
          suppressAndOrCondition: true,
          maxNumConditions: 1,
        },
        sortable: false,
      }
    };


    const theme = agGrid.themeQuartz
      .withPart(agGrid.iconSetMaterial)
      .withParams({
        accentColor: "#0E0F0C",
        browserColorScheme: "light",
        fontFamily: { googleFont: "Inter" },
        foregroundColor: "#0E0F0C",
        selectedRowBackgroundColor: 'transparent',
        headerBackgroundColor: "#FFF",
        headerFontSize: 13,
        headerRowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
        iconSize: 13,
        rowHeight: 57,
        rowBorder: { width: 1, style: "solid", color: "#e4e8ed" },
        wrapperBorder: false,
        cellTextColor: "#343433",
        headerTextColor: "#343433",
        wrapperBorderRadius: 0,
        headerColumnResizeHandleColor: "transparent",
        spacing: 8,
        oddRowBackgroundColor: "#FDFCFC",

        menuBorder: '0px', // Ingesteld voor popup/menu van filter
        menuBackgroundColor: '#F2F2F2', // Ingesteld voor popup/menu van filter
        borderColor: '#F2F2F2', // Ingesteld voor popup/menu van filter
        inputTextColor: '#454745', // Ingesteld voor popup/menu van filter
        inputPlaceholderTextColor: '#454745', // Ingesteld voor popup/menu van filter
        buttonHoverBackgroundColor: '#ffffff',// Ingesteld voor popup/menu van filter
      });


    // --- Globals & Communicatie ---
    let gridApi = null;
    let currentState = null;
    let pendingSuccessCallback = null;
    let wheelAttached = false;
    let lastAppliedColumnDefs = null;

    function sendRequestToParent(state, action, payload) {
      window.parent.postMessage({ state, action, payload, step : '3' }, 'https://www-sellerrr-com.filesusr.com');
    }

    // --- Grid Opties ---
    const baseGridOptions = {
      theme,
      defaultColDef,
      columnTypes,
      getRowId: (params) => params.data.gridRowId,
      pagination: true,
      rowModelType: 'infinite',
      paginationPageSize: 10,
      cacheBlockSize: 10,
      maxConcurrentDatasourceRequests: 1,
      maxBlocksInCache: 0, // this is 0 because onModelUpdated doesnt know how to handle trackenabled
      enableCellTextSelection: true, // tijdelijke selectie, maak een mooier alternatief later
      ensureDomOrder: true, // tijdelijke selectie, maak een mooier alternatief later

      paginationPageSizeSelector: false,
      animateRows: true,
      suppressCellFocus: true,
      undoRedoCellEditing: false,
      undoRedoCellEditingLimit: 5,
      domLayout: "autoHeight",
      loadThemeGoogleFonts: true,
      suppressHorizontalScroll: true,
      suppressNoRowsOverlay: true,
      components: {
        LinkRenderer: LinkRenderer,
        ImageRenderer: ImageRenderer,
      },

      localeText: {
        applyFilter: 'Apply filter',
        resetFilter: 'Remove filter',
      },
    }

    // --- Datasource ---
    function createDatasource() {
      return {
        getRows: (params) => {
          pendingSuccessCallback = params.successCallback;
          sendRequestToParent(currentState, 'getGridData', {
            offset: params.startRow,
            limit: params.endRow - params.startRow,
            sort: params.sortModel,
            filter: params.filterModel,
          });
        },
      };
    }

    // --- State-specifieke Logica ---
    const stateHandlers = {
      resState: {
        extraOptions: {},
        listeners: {
          onCellValueChanged: (event) => {
            // Check of de verandering uit de juiste kolom komt
            if (event.colDef.field === 'trackEnabled' && event.source === 'commit') { // er gaan twee events af en source commit is de juiste
              
              sendRequestToParent(currentState, 'trackProduct', {
                productId: event.data.productId,
                productHostname: event.data.productHostname,
                rowSelected: event.newValue, // De nieuwe waarde (true/false)
              });
            }
          },
          onCellClicked: (params) => {
            const clickableColumns = ['avgWeightedPrice', 'revenue', 'unitsSold', 'reviewRating', 'reviewCount', 'sellerCount'];
            if (clickableColumns.includes(params.column.getColId())) {
              renderChart(params.column.getColId(), params.node);
            }
          },
          onModelUpdated: (e) => {  // dit werkt misschien niet
            const trackedNodes = [];
            e.api.forEachNode(n => n.data?.trackEnabled && trackedNodes.push(n)); // n.data?.isTracked

            if (trackedNodes.length) {
                e.api.setNodesSelected({
                    nodes: trackedNodes,
                    newValue: true,
                    source: 'initialLoad',
                });
            }
          },
        },
      },
      keyState: {
        extraOptions: {},
        listeners: {},
       }
    };

    function applyStateConfig(state) {
      const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};

      /* 4A. Reset – één regel wist ALLE dynamische opties van vorige state */
      [...new Set(Object.values(stateHandlers)
        .flatMap(s => Object.keys(s.extraOptions || {})))]
        .forEach(k => gridApi.setGridOption(k, undefined));

      /* 4B. (Re)bind listeners */
      gridApi.setGridOption('onSortChanged', listeners.onSortChanged);
      gridApi.setGridOption('onFilterChanged', listeners.onFilterChanged);
      gridApi.setGridOption('onCellValueChanged', listeners.onCellValueChanged);
      gridApi.setGridOption('onModelUpdated', listeners.onModelUpdated);

      /* 4C. Apply new extra options */
      Object.entries(extraOptions)
        .forEach(([k, v]) => gridApi.setGridOption(k, v));
    }

    window.addEventListener('message', e => {
      if (e.origin !== 'https://www-sellerrr-com.filesusr.com') return;
      if (e.data.step !== '2') return;

      const { action, payload } = e.data;
      // --- ACTIE 1: Wix geeft een commando om de state te veranderen ---
      if (action === 'initGrid') {
        const { state } = payload; // We verwachten alleen de state.
        currentState = state;

        if (!gridApi) {
          // Grid bestaat niet: bouw een 'lege' grid met de juiste config en datasource.
          // De datasource zal dan ONMIDDELLIJK data opvragen.
          const { extraOptions = {}, listeners = {} } = stateHandlers[state] || {};
          gridApi = agGrid.createGrid(document.querySelector('#myGrid'), {
            ...baseGridOptions,
            ...extraOptions,
            ...listeners,
            columnDefs: [],
            datasource: createDatasource(),
          });

          if (!wheelAttached) {
            const el = document.querySelector('.ag-center-cols-viewport');
            el?.addEventListener('wheel', (e) => {
              if (!e.shiftKey && e.deltaY) {
                el.scrollLeft += e.deltaY;
                e.preventDefault();
              }
            }, { passive: false });
          }

        } else {
          // Grid bestaat al: update de config en wis de oude data.
          // Dit triggert de datasource om nieuwe data op te halen.
          applyStateConfig(state);

          gridApi.setFilterModel(null);
          gridApi.applyColumnState({ defaultState: { sort: null } });
          
          gridApi.purgeInfiniteCache();
        }
        return; // Taak volbracht.
      }

      // --- ACTIE 2: Wix stuurt de gevraagde data terug ---
      if (action === 'gridDataResponse') {
        if (!pendingSuccessCallback) return; // Geen openstaand verzoek

        const { columnDefs, rowData, totalCount } = payload;

        if (columnDefs) { gridApi.setGridOption('columnDefs', columnDefs); }

        // Geef nu de data aan de grid via de opgeslagen callback.
        pendingSuccessCallback(rowData, totalCount);
        pendingSuccessCallback = null;
        gridApi.hideOverlay();
      }

    });


  </script>

</body>

</html>